/*! Gradient Generator Concept - v0.1.0 - 2012-06-29
* http://briangrinstead.com/gradient/
* Copyright (c) 2012 Brian Grinstead */
function Gradient(a,b,c){this._colorStops=[],this._alphaStops=[],this.angle=!c&&c!=0?90:c,a=a||[];for(var d=0;d<a.length;d++)this.addColorStop(a[d].offset,a[d].color);b=b||[];for(var d=0;d<b.length;d++)this.addAlphaStop(b[d].offset,b[d].alpha)}Gradient.fromExportable=function(a){return new Gradient(a.colors.map(function(a){return{offset:a[0],color:tinycolor(a[1]).toRgbString()}}),a.alphas.map(function(a){return{offset:a[0],alpha:a[1]}}),a.angle)},Gradient.prototype.toExportable=function(){return{colors:this.getColorStops().map(function(a){return[a.getOffset(),tinycolor(a.color).toHex()]}),alphas:this.getAlphaStops().map(function(a){return[a.getOffset(),a.alpha]}),angle:this.angle}},Gradient.prototype.stopsToCSS=function(a,b,c){if(b.length===0)return"transparent";if(b.length===1)return[b[0].color];var d=b.map(function(a){return a.color+" "+Math.max(0,Math.min(parseInt(a.offset*100)))+"%"}),e=this.angleToCSSValue(a);return"linear-gradient("+e+", "+d.join(", ")+")"},Gradient.prototype.angleToCSSValue=function(a){var b=a||this.angle;typeof b=="undefined"&&(b="top"),b<0&&(b=b+360);var c={0:"left",90:"bottom",180:"right",270:"top"};return c[b]&&(b=c[b]),isNaN(parseInt(b))||(b=b+"deg"),b},Gradient.prototype.angleToGradientVector=function(a){function b(a){return{x:Math.cos(a),y:Math.sin(a)}}function c(a){return a*180/Math.PI}function d(a){return a*Math.PI/180}var e=this.getAngle(),f=Math.pow(2,-52),g=e%360,h=b(d(180-g)),i=b(d(360-g));if(h.x<=0||Math.abs(h.x)<=f)h.x=0;else if(g>90&&g<180||g>270&&g<360)h.x=parseFloat(h.x+.3);if(h.y<=0||Math.abs(h.y)<=f)h.y=0;else if(g>90&&g<180||g>270&&g<360)h.y=parseFloat(h.y+.3);if(i.x<=0||Math.abs(i.x)<=f)i.x=0;else if(g>90&&g<180||g>270&&g<360)i.x=parseFloat(i.x+.3);if(i.y<=0||Math.abs(i.y)<=f)i.y=0;else if(g>90&&g<180||g>270&&g<360)i.y=parseFloat(i.y+.3);return{x1:parseInt(h.x*100),y1:parseInt(h.y*100),x2:parseInt(i.x*100),y2:parseInt(i.y*100)}},Gradient.prototype.toCSSAlpha=function(a){var b=this.getAlphaStopsBlack();return b.length===0&&(b=[{color:"#000",offset:1}]),this.stopsToCSS(a,b)},Gradient.prototype.toSVG=function(a){var b=this.getAllStops(),c=b.map(function(a){return'<stop offset="'+a.percent+'" style="stop-color:'+a.color+";stop-opacity:"+a.alpha+';" />'}),d=this.angleToGradientVector(),e='x1="'+d.x1+'%" y1="'+d.y1+'%" x2="'+d.x2+'%" y2="'+d.y2+'%"';return['<linearGradient spreadMethod="pad" id="gradient" '+e+">",c.join("\n\t"),"</linearGradient>"].join("\n")},Gradient.prototype.getAngle=function(a){while(this.angle<0)this.angle+=360;return this.angle%360},Gradient.prototype.toCSSColor=function(a){return this.stopsToCSS(a,this.getColorStops())},Gradient.prototype.toCSS=function(a){return this.stopsToCSS(a,this.getAllStops())},Gradient.prototype.removeStop=function(a){this.removeColorStop(a),this.removeAlphaStop(a)},Gradient.prototype.removeColorStop=function(a){var b=this._colorStops.indexOf(a);b!=-1&&this._colorStops.splice(b,1)},Gradient.prototype.removeAlphaStop=function(a){var b=this._alphaStops.indexOf(a);b!=-1&&this._alphaStops.splice(b,1)},Gradient.prototype.getAllStops=function(){var a=this,b=this.getColorStops().map(function(b){var c=a.getInterpolatedAlphaAtOffset(b.offset),d=tinycolor(b.color);return d.setAlpha(c),{color:d.toString("rgb"),hex:d.toString("hex"),offset:b.offset,percent:b.getPercentOffset(),alpha:c}}),c=this.getAlphaStops().map(function(b){var c=tinycolor(a.getInterpolatedColorAtOffset(b.offset));return c.setAlpha(b.alpha),{color:c.toString("rgb"),hex:c.toString("hex"),offset:b.offset,percent:b.getPercentOffset(),alpha:b.alpha}});return c.length<2&&(c=[]),b.concat(c).unique(function(a){return a.offset}).sort(function(a,b){return a.offset-b.offset})},Gradient.prototype.getColorStops=function(){return this._colorStops.sort(function(a,b){return a.offset-b.offset})},Gradient.prototype.getAlphaStops=function(){return this._alphaStops.sort(function(a,b){return a.offset-b.offset})},Gradient.prototype.getAlphaStopsBlack=function(){return this.getAlphaStops().map(function(a){return{color:"rgba(0, 0, 0, "+a.alpha+")",offset:Math.max(0,Math.min(1,a.offset))}})},Gradient.prototype.toCanvas=function(a,b,c,d){a=a||100,b=b||100;var e=document.createElement("canvas"),f=e.getContext("2d");e.width=a,e.height=b;var g={x1:0,x2:100,y1:0,y2:0};d||(g=this.angleToGradientVector(this.angle)),g.x1=g.x1/100*a,g.x2=g.x2/100*a,g.y1=g.y1/100*b,g.y2=g.y2/100*b;var h=f.createLinearGradient(g.x1,g.y1,g.x2,g.y2),i=c||this.getAllStops();for(var j=0;j<i.length;j++)h.addColorStop(Math.max(0,Math.min(1,i[j].offset)),i[j].color);return f.fillStyle=h,f.fillRect(0,0,a,b),e},Gradient.prototype.toCanvasRules=function(a,b){var c=this.angleToGradientVector(this.angle);c.x1=c.x1/100*a,c.x2=c.x2/100*a,c.y1=c.y1/100*b,c.y2=c.y2/100*b;var d=this.getAllStops().map(function(a){return"gradient.addColorStop("+Math.max(0,Math.min(1,a.offset))+', "'+a.color+'");'});return["var canvas = document.createElement('canvas');","var context = canvas.getContext('2d')","canvas.width = "+a+";","canvas.height = "+b+";","var gradient = context.createLinearGradient("+c.x1+", "+c.y1+", "+c.x2+", "+c.y2+");",d.join("\n"),"context.fillStyle = gradient;","context.fillRect(0, 0, "+a+", "+b+");"].join("\n")},Gradient.prototype.getInterpolatedColorAtOffset=function(a){var b=this.toCanvas(100,1,this.getColorStops(),!0),c=b.getContext("2d"),d=Math.max(0,Math.min(99,parseInt(a*100))),e=c.getImageData(d,0,1,1).data;return tinycolor({r:e[0],g:e[1],b:e[2]}).toHexString()},Gradient.prototype.getInterpolatedAlphaAtOffset=function(a){var b=this.getAlphaStopsBlack();if(b.length===0)return 1;var c=this.toCanvas(100,1,b,!0),d=c.getContext("2d"),e=Math.max(0,Math.min(99,parseInt(a*100))),f=d.getImageData(e,0,1,1).data;return Math.round(f[3]/255*100)/100},Gradient.prototype.cloneStop=function(a,b){var c=a.offset,d=a.hasOwnProperty("alpha");if(b){var e=Math.random()/5,f=d?this.getAlphaStops():this.getColorStops(),g=f.indexOf(a),h=c<.5?c+e:c-e,i=g>0?f[g-1].offset:0,j=g<f.length-1?f[g+1].offset:1;Math.abs(c-h)<Math.abs(c-i)&&(h=i),Math.abs(c-h)<Math.abs(c-j)&&(h=j),c=(c+h)/2}return d?this.addAlphaStop(c,a.alpha):this.addColorStop(c,a.color)},Gradient.prototype.addColorStop=function(a,b){var c=tinycolor(b||this.getInterpolatedColorAtOffset(a));c.alpha<1&&(this.addAlphaStop(a,c.alpha),c.setAlpha(1));var d={offset:a,color:c.toString(),hex:c.toHexString(),getOffset:function(){return Math.min(1,Math.max(0,Math.round(this.offset*100)/100))},getPercentOffset:function(){return d.getOffset()*100+"%"},setOffset:function(a){d.offset=Math.min(1,Math.max(0,a))}};return this._colorStops.push(d),this.getColorStops().indexOf(d)},Gradient.prototype.addAlphaStop=function(a,b){b=b||this.getInterpolatedAlphaAtOffset(a);var c={offset:a,alpha:b,getOffset:function(){return Math.min(1,Math.max(0,Math.round(this.offset*100)/100))},getPercentOffset:function(){return c.getOffset()*100},setOffset:function(a){c.offset=Math.min(1,Math.max(0,a))}};return this._alphaStops.push(c),this.getAlphaStops().indexOf(c)},FreeStyle.GradientPicker=function(a){console.assert(a),a.addClass("gradient-picker"),this.gradient=new Gradient;var b=this;$("#track, #addstop").mousemove(function(a){$("#addstop").offset({left:a.pageX,top:$("#track").offset().top})}),$("#tracktop, #trackbottom").click(function(a){if(a.which===1){var c=(a.pageX-$(this).offset().left)/$(this).width(),d=this.id=="trackbottom",e=d?b.addColorStop(c):b.addAlphaStop(c);Generator.hardReload();var f=d?$("#stop-"+e):$("#alpha-"+e);return b.setActive(f),!1}}),$("#anglepicker").anglepicker({value:b.gradient.angle,change:function(a,c){b.gradient.angle=c.value,Generator.softReload()},start:function(a,c){b.addUndoState()},stop:function(){$("#tip").hide()}}),$("#current-angle").change(function(){var a=parseInt($(this).val(),10);isNaN(a)||(b.gradient.angle=a,Generator.softReload())}),$("#gradient-type-tabs").tabs()},FreeStyle.GradientPicker.Events={Change:"Change",StateChange:"StateChange",StopAdded:"StopAdded",StopRemoved:"StopRemoved"},FreeStyle.GradientPicker.prototype=new FreeStyle.Object,$.extend(FreeStyle.GradientPicker.prototype,{addStop:function(){},toExportable:function(){return this.gradient.toExportable()},cloneStop:function(a){var b=this.gradient.cloneStop(a,!0);this.hardReload();var c=a.hasOwnProperty("color");c?this.setActive($("#stop-"+b)):this.setActive($("#alpha-"+b))},addUndoState:function(){this.dispatchEventToListeners(FreeStyle.GradientPicker.Events.StateChange)},addColorStop:function(a){return this.addUndoState(),this.gradient.addColorStop(a)},addAlphaStop:function(a){return this.addUndoState(),this.gradient.addAlphaStop(a)},removeStop:function(a){this.addUndoState(),this.gradient.removeStop(a),a.CONTAINER.remove(),Generator.softReload()},removeCurrentStop:function(){var a=this.getActive();return a.length?(a.find(".remove").click(),!0):!1},getAngle:function(){return this.gradient.angle},getActive:function(){return $(".stop.active")},setActive:function(a){$(".stop.active").removeClass("active").blur(),a.addClass("active");var b=a.find(".color");b.length&&b.spectrum("show")},hardReload:function(){function d(b,d){function j(a){return Math.round(a.getOffset()*c-e)}d.CONTAINER=b;var e=b.outerWidth(!0)/2,f=0,g=d.hasOwnProperty("alpha"),h=40,i=100;b.draggable({axis:"x",stack:".stop",snap:".guide",snapMode:"inner",snapTolerance:3,distance:2,start:function(b,c){Generator.setActive($(this)),f=c.offset.top,$(".active .color").spectrum("hide"),Generator.softReload(),a.addUndoState()},stop:function(a,f){d.offset=(f.position.left+e)/c,f.position.left=j(d),b.removeClass("almost-removed"),Generator.softReload()},drag:function(a,k){var l=k.offset.top-f;g&&(l=f-k.offset.top),l>h?b.addClass("almost-removed"):b.removeClass("almost-removed"),l>i?b.find("button.remove").click():(d.setOffset((k.position.left+e)/c),k.position.left=j(d)),Generator.softReload()}}),b.click(function(a){if(!$(a.target).is(".remove"))Generator.setActive(b);else return!1})}var a=this,b=this.gradient,c=$("#track").width();$(".stop").remove(),$.each(b.getAlphaStops(),function(b,c){var e=$("<div class='stop alpha' id='alpha-"+b+"' />").appendTo("#track");e.append("<div class='stop-handle' />"),e.append("<div class='alpha-slider-container'><div class='alpha-slider'></div><span class='label label-info label-alpha' /></div>"),e.append('<span class="label label-inverse label-offset" />'),e.data("stop",c),d(e,c);var f=e.find(".label-info"),g=parseInt(c.alpha*100);f.text(g+"%"),e.find(".alpha-slider").slider({min:0,max:100,orientation:"vertical",value:g,slide:function(a,b){c.alpha=b.value/100,f.text(b.value+"%"),Generator.softReload()}});var h=$("<button class='btn btn-inverse remove'><i class='icon-white icon-remove' /></button>").appendTo(e);h.click(function(){a.removeStop(c)})}),$.each(b.getColorStops(),function(b,c){var e=$("<div class='stop color' id='stop-"+b+"' />").appendTo("#track");e.append("<div class='stop-handle' />"),e.append('<span class="label label-inverse label-offset" />'),d(e,c),e.data("stop",c),$("<input class='color' />").appendTo(e).spectrum({color:c.color,showInput:!0,showSelection:!0,move:function(a){c.color=a.toHexString(),Generator.softReload(),$(this).spectrum("set",a)}}).bind("spectrum.movestart",function(){a.addUndoState()}).bind("spectrum.moveend",function(){});var f=$("<span class='inc' />").appendTo(e),g=$("<button class='btn btn-inverse remove'><i class='icon-white icon-remove' /></button>").appendTo(e);g.click(function(){a.removeStop(c)})}),Generator.softReload(),$("#anglepicker").anglepicker("value",b.angle)},softReload:function(){},loadFromExportable:function(a){try{var b=a;return typeof a=="string"&&(b=JSON.parse(a)),this.gradient=Gradient.fromExportable(b),this.hardReload(),!0}catch(c){}}});var UndoManager=function(){function f(){d||(d=$("#undo")),e||(e=$("#redo")),d.toggleClass("disabled",a.length==0),e.toggleClass("disabled",b.length==0)}function g(a){log("APPLYING STATE",a);var b=JSON.parse(a);App.onStateChange(b)}function h(){return JSON.stringify(App.getState())}function i(){var d=h(),e=d!==!1&&(a.length==0||a[a.length-1]!=d);if(e){a.push(d),a.length>c&&a.shift();var g=b.length;b.length=0,f()}}function j(c){var d=c?a:b,e=c?b:a;if(d.length){var i=d.pop(),j=h();e.push(j),(d.length==0||e.length==1)&&f(),g(i)}}function k(){j(!0)}function l(){j(!1)}function m(){a=[],b=[],f()}function n(){return a}function o(){return b}var a=[],b=[],c=50,d,e;return{addState:i,undo:k,redo:l,clear:m,getUndoStack:n,getRedoStack:o}}();